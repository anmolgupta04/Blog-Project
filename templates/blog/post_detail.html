{% extends 'base.html' %}

{% block title %}
{{ post.title }}
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-7">
    <div class="post-panel p-0">
      {% if post.cover_image %}
      <div style="width:100%;height:0;padding-top:100%;position:relative;overflow:hidden;">
        <img src="{{ post.cover_image.url }}" alt="{{ post.title }}" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;" />
      </div>
      {% else %}
      <div style="width:100%;height:0;padding-top:100%;background:#eee;"></div>
      {% endif %}
    </div>
  </div>
  <div class="col-lg-5">
    <div class="post-panel p-3">
      <h5 class="mb-1">{{ post.author }}</h5>
      <p class="text-muted small">Posted on {{ post.created_at|date:"F d, Y" }}</p>
      <hr />
      <div class="mb-3">
        <button id="like-btn" class="btn btn-light border" data-slug="{{ post.slug }}">
          <span id="like-icon">{% if user in post.likes.all %}‚ù§Ô∏è{% else %}ü§ç{% endif %}</span>
        </button>
        <span id="like-count" class="ms-2">{{ post.likes.count }}</span>
      </div>
      <div class="post-content mb-3">{{ post.content|safe }}</div>
      <hr />
      <div class="post-comments">
    <!-- Title -->
    <h1 class="mt-4">{{ post.title }}</h1>
    <!-- Author -->
    <p class="lead">by {{ post.author }}</p>
    <hr />
    <!-- Date/Time -->
    <p>Posted on {{ post.created_at|date:"F d, Y" }}</p>
    <hr />
      <!-- Comments Form -->
      <div class="mb-3">
        <h6>Leave a comment</h6>
        {% if user.is_authenticated %}
        <form method="post">
          {% csrf_token %}
          {{ comment_form.as_p }}
          <button type="submit" class="btn btn-sm btn-primary">Submit</button>
        </form>
        {% else %}
        <p>Please <a href="{% url 'login' %}">log in</a> to leave a comment.</p>
        {% endif %}
      </div>

      <!-- Single Comment -->
      {% for comment in comments %}
      <div class="d-flex mb-3">
        <img class="rounded-circle me-2" src="https://dummyimage.com/40x40/ced4da/6c757d.jpg" alt="..." />
        <div>
          <div class="fw-bold">{{ comment.author }} <small class="text-muted">{{ comment.created_at|timesince }} ago</small></div>
          <div>{{ comment.content }}</div>
        </div>
      </div>
      {% empty %}
      <p class="text-muted">No comments yet.</p>
      {% endfor %}
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
    <div class="card my-4">
      <h5 class="card-header">Leave a Comment:</h5>
      <div class="card-body">
        {% if user.is_authenticated %}
        <form method="post">
          {% csrf_token %} {{ comment_form.as_p }}
          <button type="submit" class="btn btn-primary">Submit</button>
        </form>
        {% else %}
        <p>Please <a href="{% url 'login' %}">log in</a> to leave a comment.</p>
        {% endif %}
      </div>
    </div>

    <!-- Single Comment -->
    {% for comment in comments %}
    <div class="d-flex mb-4">
      <div class="flex-shrink-0">
        <img
          class="rounded-circle"
          src="https://dummyimage.com/50x50/ced4da/6c757d.jpg"
          alt="..."
        />
      </div>
      <div class="ms-3">
        <div class="fw-bold">
          {{ comment.author }}
          <small class="text-muted"
            >{{ comment.created_at|timesince }} ago</small
          >
        </div>
        {{ comment.content }}
      </div>
    </div>
    {% empty %}
    <p>No comments yet.</p>
    {% endfor %}
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const likeBtn = document.getElementById("like-btn");
    if (likeBtn) {
      likeBtn.addEventListener("click", function () {
        const slug = this.dataset.slug;
        fetch(`/post/${slug}/like/`, {
          method: "POST",
          headers: {
            "X-CSRFToken": "{{ csrf_token }}",
            "Content-Type": "application/json",
          },
        })
          .then((response) => response.json())
          .then((data) => {
            const icon = document.getElementById("like-icon");
            const count = document.getElementById("like-count");

            if (data.liked) {
              icon.textContent = "‚ù§Ô∏è";
            } else {
              icon.textContent = "ü§ç";
            }
            count.textContent = data.count;
          });
      });
    }
  });
</script>
{% endblock %}
